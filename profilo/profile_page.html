<!DOCTYPE html>
<html lang="it-IT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>profile</title>
    <link type="text/CSS" rel="stylesheet" href="profile_page.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>
    <script src="js/profile_page.js"></script>
    <script src="js/script_selezione.js"></script>
    <script src="js/scarica.js"></script>
    <link rel="icon" href="img\logo_favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styleNote.css">
    <!-- inserire qui una nuova immagine come logo della finestra nel browser, chiedere a forna di farla-->
</head>

<body onload="setAll()">
    <!--<?php
        session_start();
        $conn = new mysqli("localhost","root","","share-notes");
        include "utils.inc.php";

        if (isLogged()) {
            echo "<script>alert('Devi prima loggarti per poter prendere appunti.')
                    setTimeout(function() {
                    window.location.replace(\"index.html\");
                    }, 0)
                </script>";
        }

        if(isset($_POST['share'])){ //da aggiungere  a Matte...
            $code = $_POST['share'];
            $checkShare = "SELECT mia FROM nota WHERE codicenota=$code";
            $resultCShare = $conn->query($checkShare);
            $mia = ($resultCShare->fetch_assoc())['mia'];
            if($mia == 1){
                $queryShare = "UPDATE nota SET condivisa=1 WHERE codicenota=$code";
                $resultShare = $conn->query($queryShare);
                if(!$resultShare){
                    echo '<script>
                        alert("Non e\' stato possibile condividere la nota, riprova in seguito...");
                    </script>';
                }
            }else {
                echo '<script>
                    alert("Non puoi condividere una nota non tua, devi prima modificarla...");
                </script>';
            }
        }

        if(isset($_POST['creaNota']) and ((int) $_POST['creaNota']) == 1){
            if (sexOrCock()){
                $mail = (string) $_SESSION["UserData"]["email"];
                $classe = (string) $_SESSION["UserData"]["classe"];
            }else {
                $mail = (string) $_COOKIE["UserMail"];
                $queryClass = "SELECT * FROM user WHERE mail='$mail'";
                $resultClass = $conn->query($queryClass);
                $classe = ($resultClass->fetch_assoc())['classe'];
            }
            $titolo = "NotaBianca";
            $querySearch = "SELECT * FROM nota WHERE email='$mail' and titolo='$titolo'";
            $resultSearch = $conn->query($querySearch);
            
            if($resultSearch->num_rows > 0){
                echo '<script>
                    alert("Hai già una nuova nota non modificata!?!; Sei pregato di usare prima quella.");
                </script>';
            }else{
                $queryNuovaNota = "INSERT INTO nota(email, classe) VALUES ('$mail','$classe')";
                $resultNuovaNota = $conn->query($queryNuovaNota);
                $queryCodice = "SELECT * FROM nota WHERE email='$mail' and titolo='$titolo'";
                $resultCodice = $conn->query($queryCodice);
                $codiceAr = $resultCodice->fetch_assoc();
                $codice = $codiceAr["codicenota"];
                echo '<form method="post" action="download.php" id="fTSend">
                    <input type="number" name="codNota" style="display: none;" value='.$codice.'>
                </form>
                <script>
                    document.getElementById("fTSend").submit();
                </script>';
            }
            unset($_POST['creaNota']);
        }

        if (isset($_SESSION["UserData"])){
            $mail = (string) $_SESSION["UserData"]["email"];
			$nomeUtente = (string) $_SESSION["UserData"]["name"];
        }else {
            $mail = (string) $_COOKIE["UserMail"];
			$query_nome = "SELECT name FROM user WHERE email='".trim($mail)."'";
			$result_nome = $conn->query($query_nome);
			$nomeUtente = (string) ($result_nome->fetch_assoc())['name'];
        }

        if(isset($_POST['eliminaNota'])){
            $checkNota = "SELECT * FROM nota WHERE email='$mail'";
            $resultCheck = $conn->query($checkNota);
            $numNota = $resultCheck->num_rows;
            if($numNota > 1){
                $code = $_POST['eliminaNota'];
                $eliminazione = "DELETE FROM nota WHERE codicenota=$code";
                $resultEliminazione = $conn->query($eliminazione);
                if(!$resultEliminazione){
                    echo '<script>
                        alert("La nota non e\' stata eliminata correttamente, riprovare in seguito...");
                    </script>';
                }
            }else {
                echo '<script>
                        alert("La nota che stai tentando di eliminare e\' l\'ultima che ti rimane, non puoi eliminarla...");
                    </script>';
            }
        }

        function printNote($codice, $title, $content, $classe, $anno, $likes){ //In più rispetto a Matte... (poi da aggiungere)
            echo '<div class="NoteBlock">
                    <form method="POST" action="download.php" class="Apri">
                        <button name="codNota" class="ApriNota" value=', $codice, '>', $title,'<img src="img/matita2.png" class="matita"></button>
                    </form>
                    <div class="Dati">
                        <h5 class="titleDati">Dati:</h5>
                        <li class="listDati">
                            <ul>Classe: '.$classe.'</ul>
                            <ul>Anno: '.$anno.'</ul>
                            <ul>Likes: '.$likes.'</ul>
                        </li>
                    </div>
                    <form method="POST" action="profile_page.php" class="Elimina">
                        <button name="eliminaNota" value=', $codice, ' class="EliminaNota"><img src="img/bidone3.png" class="bidone"></button>
                    </form>
                    <form action="profile_page.php" method="post" class="Condividi">
                        <button name="share" value=', $codice, ' class="CondividiNota"><img src="img/share1.png" class="share"></button>
                    </form>
                    <button onclick="downloadNota(\''.$title.'\',\''.$content.'\')" class="DownloadNota"><img src="img/scarica1.png" class="scarica"></button>
                </div>';
        }

		function mostra($mat, $mail, $conn, $anno = 0, $appartenenza = 2){
            $anno = (int) $anno;
            $appartenenza = (int) $appartenenza;
			$query_num_mate = "SELECT * FROM nota WHERE email='$mail' and materia='$mat'";
			$result_num_mate = $conn->query($query_num_mate);
			$num_mate = mysqli_num_rows($result_num_mate);
			$mate = array();
			while ($row = $result_num_mate->fetch_assoc()) {
				$mate[] = $row;
			}
			for ($j = 0; $j < $num_mate; $j++) {
				$codice = $mate[$j]['codicenota'];
				$title = $mate[$j]['titolo'];
                $app = (int) $mate[$j]['mia'];
                $ann = (int) $mate[$j]['annoScolastico'];
                $content = (string) $mate[$j]['contenuto'];
                $likes = (int) $mate[$j]['likes'];
                $class = (string) $mate[$j]['classe'];
                if($appartenenza == 2){
                    if($anno == 0){
                        printNote($codice, $title, $content, $class, $ann, $likes); //manca la classe
                    }else if($anno == $ann){
                        printNote($codice, $title, $content, $class, $ann, $likes);
                    }
                }else if($appartenenza == $app){         //da aggiungere tutti i printNote...
                    if($anno == 0){
                        printNote($codice, $title, $content, $class, $ann, $likes);
                    }else if($anno == $ann){
                        printNote($codice, $title, $content, $class, $ann, $likes);
                    }
                }
			}
		}

        function stampaMaterie($conn){        //da aggiungere a Matteo...
            $queryMaterie = "SELECT * FROM materia";
            $resultMaterie = $conn->query($queryMaterie);
            $numMaterie = mysqli_num_rows($resultMaterie);
            $Materie = array();
            while ($row = $resultMaterie->fetch_assoc()) {
                $Materie[] = $row;
            }
            for($j = 0; $j < $numMaterie; $j++){
                echo '<option value="'.$Materie[$j]['nome'].'">'.$Materie[$j]['nome'].'</option>';
            }
        }

        function stampaCartelleMaterie($conn, $mail){
            $filtro = 'All';

            if(isset($_POST['Classe'])){
                $year = (int) $_POST['Classe'];
            }
    
            if(isset($_POST['Proprieta'])){
                $mine = (int) $_POST['Proprieta'];
            }

            if(isset($_POST['Materia'])){
                $filtro = (string) $_POST['Materia'];
            }

            $queryMat = "SELECT * FROM materia";
            $resultMat = $conn->query($queryMat);
            $numMat = mysqli_num_rows($resultMat);
            $Mat = array();
            while ($row = $resultMat->fetch_assoc()) {
                $Mat[] = $row;
            }
            for($j = 0; $j < $numMat; $j++){
                $materiaCorrente = $Mat[$j]['nome'];
                if($filtro == 'All'){
                    echo '<div class="folders" id="folder-'.$materiaCorrente.'" onclick="cambiaStatoMateria(\'folder-'.$materiaCorrente.'\')">
                        <h6 class="'.$materiaCorrente.'" id="titleSub-'.$materiaCorrente.'">'.$materiaCorrente.'
                            <h6>
                                <hr class="line-horizontal">';
                                if(isset($year)){
                                    if(isset($mine)){
                                        mostra($materiaCorrente, $mail, $conn, $year, $mine);
                                    }else {
                                        mostra($materiaCorrente, $mail, $conn, $year);
                                    }
                                }else{
                                    if(isset($mine)){
                                        mostra($materiaCorrente, $mail, $conn, 0, $mine);
                                    }else {
                                        mostra($materiaCorrente, $mail, $conn);
                                    } 
                                }
                    echo '</div>';
                }else if($materiaCorrente == $filtro){
                    echo '<div class="folders" id="folder-'.$materiaCorrente.'" onclick="cambiaStatoMateria(\'folder-'.$materiaCorrente.'\')">
                        <h6 class="'.$materiaCorrente.'" id="titleSub-'.$materiaCorrente.'">'.$materiaCorrente.'
                            <h6>
                                <hr class="line-horizontal">';
                                if(isset($year)){
                                    if(isset($mine)){
                                        mostra($materiaCorrente, $mail, $conn, $year, $mine);
                                    }else {
                                        mostra($materiaCorrente, $mail, $conn, $year);
                                    }
                                }else{
                                    if(isset($mine)){
                                        mostra($materiaCorrente, $mail, $conn, 0, $mine);
                                    }else {
                                        mostra($materiaCorrente, $mail, $conn);
                                    } 
                                }
                    echo '</div>';
                }
            }
        }
        ?>-->
    <div class='container-verti'>
        <div class='horizontal'>
            <a href="index.php"><img class="logo" src="img/logo.png"></a>
            <a href="index.php"><button class="top-buttons-style">Home</button></a>
            <a href="aboutPage.html"><button class="top-buttons-style">Chi siamo?</button></a>
            <a href="#"><button class="top-buttons-style">Cerca appunti</button></a>
            <a href="#"><button class="top-buttons-style">Funzionalità</button></a>
            <hr class="line-horizontal">
            <div class="open-zone">
                <h1 class="main-title">Appunti</h1>
                <div class="scrollable">
                    <!--<?php stampaCartelleMaterie($conn, $mail) ?>-->
                </div>
                <p class="crea-txt">Crea</p>
                <form action="profile_page.php" method="post">
                    <button value=1 name="creaNota" style="background:none; border:none;"> <!-- da aggiungere a matte... -->
                        <img src="img\create.png" class="create-btn">
                    </button>
                </form>
            </div>
        </div>
        <hr class="line-vertical">
        <div class='vertical'>
            <img src="img/user.png" class="user-img">
            <h1 class="center-user-name"><!--<?php echo $nomeUtente ?>-->
                <h1>
                    <h3 class="center-user-mail"><!--<?php echo $mail ?>-->
                        <h3>
                            <div class="line-horizontal"></div>
                            <h3 class="divisions">Divisioni</h3>
                            <nav class="division-column">
                                <ul>
                                <form action="profile_page.php" method="post" id="formFilter">
                                    <li>
                                        <select id="materia" name="Materia" class="options-dims" onchange="submitSelected('materia')">
            					            <option value="All">All</option>
                                            <!--<?php stampaMaterie($conn) ?>-->
							            </select>
                                    </li>
                                        <li>
                                            <select id="classe" name="Classe" class="options-dims" onchange="submitSelected('classe')">
            					                <option value=0>All</option>
  								                <option value=1>Prima</option>
  								                <option value=2>Seconda</option>
 								                <option value=3>Terza</option>
  								                <option value=4>Quarta</option>
  								                <option value=5>Quinta</option>
							                </select>
                                        </li>
                                        <li>
                                            <select id="proprita" name="Proprieta" class="options-dims" onchange="submitSelected('proprita')">
            					                <option value=2>All</option>
  								                <option value=1>Creati da te</option>
  								                <option value=0>Creati da altri</option>
							                </select>
                                        </li>
                                </form>
                                <ul>
                            </nav>
                            <form action="index.php" method="post">
                                <button type="submit" name="loGOut" value=1 style="background:none; border:none;"><img class="exit-btn" src="img\exit.png"></button> <!-- da aggiungere a matte... -->
                            </form>
                            <!--<a href="logout.php"><img class="exit-btn" src="img\exit.png"></a>-->
                            <!--tag probabilmente da cambiare per far uscire l'utente dall'account-->
        </div>
    </div>
</body>

</html>